# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define parameters for the workflow
parameters:
  github_username:
    type: string
    default: "bak3y"
  image_name:
    type: string
    default: "k8s-ephemeral-storage-metrics"
  dockerfile:
    type: string
    default: "Dockerfile"

# Define reusable commands
commands:
  setup-docker-buildx:
    description: "Setup Docker Buildx for multi-platform builds"
    steps:
      - run:
          name: Setup Docker Buildx
          command: |
            docker buildx version
            docker buildx create --name builder --use || true
            docker buildx inspect --bootstrap

  setup-image-vars:
    description: "Set up image name environment variables"
    steps:
      - run:
          name: Setup image variables
          command: |
            IMAGE_TAG="${CIRCLE_SHA1:0:7}"
            FULL_IMAGE_NAME="ghcr.io/${GITHUB_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
            TEMP_IMAGE_NAME="ghcr.io/${GITHUB_USERNAME}/${IMAGE_NAME}:prescan"
            echo "export IMAGE_TAG=$IMAGE_TAG" >> $BASH_ENV
            echo "export FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $BASH_ENV
            echo "export TEMP_IMAGE_NAME=$TEMP_IMAGE_NAME" >> $BASH_ENV

  docker-login:
    description: "Login to GitHub Container Registry"
    steps:
      - run:
          name: Login to GitHub Container Registry
          command: |
            if [ -z "$GITHUB_TOKEN" ]; then
              echo "Error: GITHUB_TOKEN environment variable is not set"
              exit 1
            fi
            mkdir -p ~/.docker
            echo -n "${GITHUB_USERNAME}:${GITHUB_TOKEN}" | base64 > /tmp/auth.txt
            echo "{\"auths\":{\"ghcr.io\":{\"auth\":\"$(cat /tmp/auth.txt)\"}}}" > ~/.docker/config.json
            rm /tmp/auth.txt

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build:
    machine:
      image: ubuntu-2204:current
    environment:
      IMAGE_NAME: << pipeline.parameters.image_name >>
      DOCKERFILE: << pipeline.parameters.dockerfile >>
      GITHUB_USERNAME: << pipeline.parameters.github_username >>
    steps:
      - checkout
      - setup-docker-buildx
      - setup-image-vars
      - docker-login
      - run:
          name: Build and push Docker image with temp tag (multi-platform)
          command: |
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --tag "${TEMP_IMAGE_NAME}" \
              --file "${DOCKERFILE}" \
              --push \
              .

  scan:
    machine:
      image: ubuntu-2204:current
    environment:
      IMAGE_NAME: << pipeline.parameters.image_name >>
      GITHUB_USERNAME: << pipeline.parameters.github_username >>
    steps:
      - setup-image-vars
      - docker-login
      - run:
          name: Scan image for vulnerabilities
          command: |
            # Scan the pushed temp-tagged image using Trivy
            # Exit code 1 will fail the build on HIGH/CRITICAL vulnerabilities
            # This ensures we only retag safe images
            docker run --rm \
              -v ~/.docker/config.json:/root/.docker/config.json:ro \
              aquasec/trivy:latest image \
              "${TEMP_IMAGE_NAME}" \
              --exit-code 1 \
              --severity HIGH,CRITICAL \
              --format table
      - run:
          name: Delete temp image on scan failure
          command: |
            # Get package version ID for the "prescan" tag and delete it
            # GitHub API requires version ID, not tag name, so we find the version with "prescan" tag
            # Note: Use 'orgs' for organization packages, 'users' for personal account packages
            RESPONSE=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/orgs/${GITHUB_USERNAME}/packages/container/${IMAGE_NAME}/versions")

            # Find the version ID that has "prescan" in its tags array
            # Parse JSON to find object with "prescan" tag and extract its id
            PACKAGE_VERSION_ID=$(echo "$RESPONSE" | awk '
              /"id"/ { id = $0; gsub(/[^0-9]/, "", id); current_id = id }
              /"prescan"/ { if (current_id) print current_id; exit }
            ' || true)

            if [ -n "$PACKAGE_VERSION_ID" ] && [ "$PACKAGE_VERSION_ID" != "" ]; then
              curl -X DELETE \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                "https://api.github.com/orgs/${GITHUB_USERNAME}/packages/container/${IMAGE_NAME}/versions/${PACKAGE_VERSION_ID}" || true
            fi
          when: on_fail

  push:
    machine:
      image: ubuntu-2204:current
    environment:
      IMAGE_NAME: << pipeline.parameters.image_name >>
      GITHUB_USERNAME: << pipeline.parameters.github_username >>
    steps:
      - setup-docker-buildx
      - setup-image-vars
      - docker-login
      - run:
          name: Retag temp image to final tag
          command: |
            docker buildx imagetools create "${TEMP_IMAGE_NAME}" --tag "${FULL_IMAGE_NAME}"
      - run:
          name: Delete temp image tag
          command: |
            # Get package version ID for the "prescan" tag and delete it
            # GitHub API requires version ID, not tag name, so we find the version with "prescan" tag
            # Note: Use 'orgs' for organization packages, 'users' for personal account packages
            RESPONSE=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
              "https://api.github.com/orgs/${GITHUB_USERNAME}/packages/container/${IMAGE_NAME}/versions")

            # Find the version ID that has "prescan" in its tags array
            # Parse JSON to find object with "prescan" tag and extract its id
            PACKAGE_VERSION_ID=$(echo "$RESPONSE" | awk '
              /"id"/ { id = $0; gsub(/[^0-9]/, "", id); current_id = id }
              /"prescan"/ { if (current_id) print current_id; exit }
            ' || true)

            if [ -n "$PACKAGE_VERSION_ID" ] && [ "$PACKAGE_VERSION_ID" != "" ]; then
              curl -X DELETE \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                "https://api.github.com/orgs/${GITHUB_USERNAME}/packages/container/${IMAGE_NAME}/versions/${PACKAGE_VERSION_ID}" || true
            fi

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  build-scan-push:
    # Run on all pushes and tags
    # To limit to specific branches, add filters to the jobs below
    jobs:
      - build
      - scan:
          requires:
            - build
      - push:
          requires:
            - scan
